{% extends 'products/base.html' %}

{% block title %}{{ category.name }} | JEFI.sk{% endblock %}

{% block content %}
<div class="bg-gray-50 min-h-screen pb-20">
    
    <div class="bg-white border-b border-gray-200 sticky top-20 z-30 shadow-sm">
        <div class="container mx-auto px-6 py-3">
            <nav class="flex text-sm text-gray-500 overflow-x-auto whitespace-nowrap items-center">
                <a href="{% url 'home' %}" class="hover:text-blue-600 flex items-center gap-1 transition-colors">
                    <i class="fa fa-home"></i> Domov
                </a>
                
                {% if category.parent %}
                <span class="mx-2 text-gray-300">/</span>
                <a href="{% url 'category_detail' category.parent.slug %}" class="hover:text-blue-600 transition-colors">
                    {{ category.parent.name }}
                </a>
                {% endif %}
                
                <span class="mx-2 text-gray-300">/</span>
                <span class="text-gray-900 font-bold text-blue-700">{{ category.name }}</span>
            </nav>
        </div>
    </div>

    <div class="container mx-auto px-6 py-8">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
            
            <aside class="hidden md:block col-span-1">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden sticky top-36">
                    <div class="bg-slate-50 p-4 border-b border-gray-100">
                        <h3 class="font-bold text-gray-800 flex items-center gap-2">
                            <i class="fa fa-list-ul text-blue-600"></i> Kategórie
                        </h3>
                    </div>
                    <nav class="p-2 max-h-[calc(100vh-250px)] overflow-y-auto custom-scrollbar">
                        <ul class="space-y-1">
                            {% for cat in all_categories %}
                                {% if cat.is_active %}
                                <li>
                                    <a href="{% url 'category_detail' cat.slug %}" class="flex items-center justify-between px-3 py-2.5 rounded-lg text-sm font-medium transition group
                                        {% if cat.slug == category.slug or cat.slug == category.parent.slug %} 
                                            bg-blue-600 text-white shadow-md
                                        {% else %} 
                                            text-gray-600 hover:bg-blue-50 hover:text-blue-700 
                                        {% endif %}">
                                        
                                        <span>{{ cat.name }}</span>
                                        
                                        {% if cat.slug != category.slug and cat.slug != category.parent.slug %}
                                            <i class="fa fa-chevron-right text-xs text-gray-300 group-hover:text-blue-400"></i>
                                        {% endif %}
                                    </a>
                                    
                                    {% if cat.slug == category.slug or cat.slug == category.parent.slug %}
                                        {% if cat.children.exists %}
                                        <ul class="ml-4 mt-1 border-l-2 border-blue-100 pl-2 space-y-1">
                                            {% for child in cat.children.all %}
                                                {% if child.is_active %}
                                                <li>
                                                    <a href="{% url 'category_detail' child.slug %}" class="block px-3 py-1.5 text-xs rounded-md transition
                                                        {% if child.slug == category.slug %} text-blue-700 font-bold bg-blue-50 {% else %} text-gray-500 hover:text-blue-600 hover:bg-gray-50 {% endif %}">
                                                        {{ child.name }}
                                                    </a>
                                                </li>
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
                                        {% endif %}
                                    {% endif %}
                                </li>
                                {% endif %}
                            {% endfor %}
                        </ul>
                    </nav>
                    
                    <div class="p-4 mt-2 border-t border-gray-100 bg-orange-50/50">
                        <p class="text-xs text-gray-500 mb-2 font-semibold">Neviete si vybrať?</p>
                        <a href="{% url 'builder' %}" class="block text-center bg-white border border-orange-200 text-orange-600 font-bold text-xs py-2 rounded-lg hover:bg-orange-600 hover:text-white transition shadow-sm">
                            <i class="fa fa-magic mr-1"></i> Skúsiť Konfigurátor
                        </a>
                    </div>
                </div>
            </aside>

            <main class="col-span-1 md:col-span-3">
                
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                    <div>
                        <h1 class="text-3xl font-black text-gray-900">{{ category.name }}</h1>
                        <p class="text-gray-500 text-sm mt-1">
                            Prezeráte si produkty z kategórie
                        </p>
                    </div>
                    
                    <form method="get" class="flex items-center gap-2 bg-white p-1.5 rounded-lg border border-gray-200 shadow-sm">
                        <label class="text-xs text-gray-500 font-bold uppercase px-2">Zoradiť:</label>
                        <select name="sort" onchange="this.form.submit()" class="bg-transparent text-sm font-medium text-gray-700 focus:outline-none cursor-pointer">
                            <option value="default" {% if sort_by == 'default' %}selected{% endif %}>Odporúčané</option>
                            <option value="price_asc" {% if sort_by == 'price_asc' %}selected{% endif %}>Najlacnejšie</option>
                            <option value="price_desc" {% if sort_by == 'price_desc' %}selected{% endif %}>Najdrahšie</option>
                            <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Podľa názvu</option>
                        </select>
                    </form>
                </div>

                {% if category.children.exists %}
                <div class="mb-10">
                    <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                        <i class="fa fa-folder text-blue-300"></i> Podkategórie
                    </h2>
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                        {% for child in category.children.all %}
                            {% if child.is_active %}
                            <a href="{% url 'category_detail' child.slug %}" class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm hover:shadow-md hover:border-blue-300 transition text-center group h-full flex flex-col items-center justify-center min-h-[100px]">
                                <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mb-3 group-hover:bg-blue-600 group-hover:text-white transition">
                                    <i class="fa fa-folder-open"></i>
                                </div>
                                <h3 class="font-bold text-sm text-gray-800 group-hover:text-blue-700 leading-tight line-clamp-2">
                                    {{ child.name }}
                                </h3>
                            </a>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if products %}
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="product-list">
                    {% include 'products/partials/product_grid.html' %}
                </div>
                
                {% if has_next %}
                <div class="text-center mt-12 mb-8" id="load-more-container">
                    <button id="load-more-btn" 
                            data-page="{{ next_page }}" 
                            data-url="{% url 'category_detail' category.slug %}"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full transition duration-300 shadow-md flex items-center justify-center mx-auto gap-2">
                        <span>Zobraziť ďalšie produkty</span>
                        <svg id="load-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                </div>
                {% endif %}

                <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const loadMoreBtn = document.getElementById('load-more-btn');
                    
                    if (loadMoreBtn) {
                        loadMoreBtn.addEventListener('click', function() {
                            const btn = this;
                            const url = btn.getAttribute('data-url');
                            const page = btn.getAttribute('data-page');
                            
                            const urlParams = new URLSearchParams(window.location.search);
                            const sort = urlParams.get('sort') || 'default';
                            
                            btn.querySelector('span').textContent = 'Načítavam...';
                            btn.querySelector('#load-spinner').classList.remove('hidden');
                            btn.disabled = true;
                            btn.classList.add('opacity-75', 'cursor-not-allowed');

                            fetch(`${url}?page=${page}&sort=${sort}&ajax=1`, {
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest'
                                }
                            })
                            .then(response => response.json())
                            .then(data => {
                                document.getElementById('product-list').insertAdjacentHTML('beforeend', data.html);
                                
                                if (data.has_next) {
                                    btn.setAttribute('data-page', parseInt(page) + 1);
                                    btn.querySelector('span').textContent = 'Zobraziť ďalšie produkty';
                                    btn.querySelector('#load-spinner').classList.add('hidden');
                                    btn.disabled = false;
                                    btn.classList.remove('opacity-75', 'cursor-not-allowed');
                                } else {
                                    document.getElementById('load-more-container').remove();
                                }
                            })
                            .catch(error => {
                                console.error('Chyba:', error);
                                btn.querySelector('span').textContent = 'Chyba siete. Skúste znova.';
                                btn.querySelector('#load-spinner').classList.add('hidden');
                                btn.disabled = false;
                            });
                        });
                    }
                });
                </script>
                
                {% else %}
                <div class="text-center py-24 bg-white rounded-2xl border-2 border-dashed border-gray-200">
                    <div class="inline-flex items-center justify-center w-20 h-20 bg-gray-50 rounded-full mb-6">
                        <i class="fa fa-search text-3xl text-gray-300"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800 mb-2">Žiadne produkty sa nenašli</h2>
                    <p class="text-gray-500 max-w-sm mx-auto mb-6">V tejto kategórii momentálne nemáme žiadne produkty alebo nezodpovedajú filtrom.</p>
                    
                    {% if not category.children.exists %}
                        <a href="{% url 'home' %}" class="inline-block bg-blue-600 text-white font-bold px-6 py-3 rounded-full hover:bg-blue-700 transition shadow-lg shadow-blue-200">
                            Späť na domov
                        </a>
                    {% endif %}
                </div>
                {% endif %}

            </main>
        </div>
    </div>
</div>
{% endblock %}