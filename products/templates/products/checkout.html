{% extends 'products/base.html' %}

{% block content %}
<div class="bg-gray-50 min-h-screen py-10">
    <div class="container mx-auto px-6 max-w-4xl">

        <h1 class="text-3xl font-black text-gray-900 mb-8 text-center">Dokončenie objednávky</h1>

        <div class="flex flex-col md:flex-row gap-8">
            
            <div class="md:w-2/3">
                <form method="post" id="checkout-form" class="bg-white p-8 rounded-2xl shadow-lg border border-gray-100">
                    {% csrf_token %}
                    
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">1. Spôsob doručenia</h2>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                        {% for radio in form.delivery_method %}
                        <label class="cursor-pointer relative group">
                            {{ radio.tag }} <div class="border-2 border-gray-200 rounded-xl p-4 hover:border-blue-400 peer-checked:border-blue-600 peer-checked:bg-blue-50 transition-all h-full flex flex-col justify-center text-center">
                                <div class="font-bold text-gray-900 group-hover:text-blue-600">
                                    {% if radio.data.value == 'courier' %}
                                        <i class="fa fa-truck text-2xl mb-2 block text-blue-500"></i>
                                        Kuriér na adresu
                                    {% else %}
                                        <i class="fa fa-box-open text-2xl mb-2 block text-orange-500"></i>
                                        Výdajný Box / Miesto
                                    {% endif %}
                                </div>
                                <div class="text-sm text-gray-500 mt-1">
                                    {% if radio.data.value == 'courier' %}
                                        +4.90 €
                                    {% else %}
                                        +2.90 €
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="absolute top-3 right-3 text-blue-600 opacity-0 peer-checked:opacity-100 transition">
                                <i class="fa fa-check-circle"></i>
                            </div>
                        </label>
                        {% endfor %}
                    </div>

                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">2. Dodacie údaje</h2>
                    <div class="space-y-5 mb-6">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">Meno a Priezvisko</label>
                                {{ form.customer_name }}
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-1">E-mail</label>
                                {{ form.customer_email }}
                            </div>
                        </div>

                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label id="address-label" class="block text-sm font-bold text-gray-700">
                                    Adresa doručenia
                                </label>
                                
                                <a href="https://widget.packeta.com/v6/#/" target="_blank" id="map-link" class="hidden text-xs font-bold text-blue-600 hover:underline">
                                    <i class="fa fa-map-marker-alt mr-1"></i> Nájsť box na mape
                                </a>
                            </div>

                            {{ form.customer_address }}
                            
                            <p id="address-hint" class="text-xs text-gray-400 mt-1">
                                Ulica, číslo domu, Mesto a PSČ.
                            </p>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Poznámka</label>
                            {{ form.note }}
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-gray-900 text-white py-4 rounded-xl font-bold text-lg hover:bg-blue-600 transition shadow-lg flex justify-center items-center group">
                        Záväzne objednať
                        <i class="fa fa-arrow-right ml-2 group-hover:translate-x-1 transition"></i>
                    </button>
                    
                    <p class="text-center text-xs text-gray-400 mt-4">
                        Odoslaním súhlasíte s obchodnými podmienkami.
                    </p>
                </form>
            </div>

            <div class="md:w-1/3">
                <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm sticky top-24">
                    <h3 class="font-bold text-gray-900 mb-4 text-lg">Zhrnutie objednávky</h3>
                    
                    <div class="space-y-3 mb-6 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                        {% for item in cart_items %}
                        <div class="flex justify-between text-sm group">
                            <span class="text-gray-600 w-2/3 truncate group-hover:text-blue-600 transition">{{ item.product.name }}</span>
                            <span class="font-bold text-gray-900">{{ item.price|floatformat:2 }} €</span>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="border-t border-gray-100 pt-4 space-y-2 text-sm">
                        <div class="flex justify-between text-gray-500">
                            <span>Medzisúčet:</span>
                            <span>{{ total_price|floatformat:2 }} €</span>
                        </div>
                        <div class="flex justify-between text-blue-600 font-bold bg-blue-50 p-2 rounded-lg">
                            <span>Doprava:</span>
                            <span id="shipping-display">...</span>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 pt-4 mt-4">
                        <div class="flex justify-between items-end">
                            <span class="font-bold text-lg text-gray-700">K úhrade:</span>
                            <span class="font-black text-3xl text-gray-900 tracking-tight" id="total-display">--- €</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Premenné
        const totalGoods = {{ total_price|stringformat:".2f" }};
        const radios = document.querySelectorAll('input[name="delivery_method"]');
        const shippingDisplay = document.getElementById('shipping-display');
        const totalDisplay = document.getElementById('total-display');
        
        // Elementy pre dynamickú zmenu textu
        const addressLabel = document.getElementById('address-label');
        const addressInput = document.getElementById('id_customer_address'); // Django ID
        const addressHint = document.getElementById('address-hint');
        const mapLink = document.getElementById('map-link');

        function updateUI() {
            let selectedValue = 'courier';
            let shippingCost = 4.90;

            // Zisti, čo je vybraté
            radios.forEach(radio => {
                if (radio.checked) {
                    selectedValue = radio.value;
                }
            });

            // Logika prepínania
            if (selectedValue === 'courier') {
                shippingCost = 4.90;
                
                // Zmena textov pre Kuriéra
                addressLabel.innerText = "Adresa doručenia (Domov/Práca)";
                addressInput.placeholder = "Ulica 123, 821 01 Bratislava";
                addressHint.innerText = "Tovar vám doručí kuriér priamo do rúk.";
                mapLink.classList.add('hidden'); // Skryť mapu
            } else {
                shippingCost = 2.90;
                
                // Zmena textov pre Box
                addressLabel.innerText = "Názov a adresa výdajného miesta";
                addressInput.placeholder = "Napr. Z-Box Tesco, Panónska cesta...";
                addressHint.innerText = "Prosím, skopírujte presný názov boxu z mapy.";
                mapLink.classList.remove('hidden'); // Ukázať mapu
            }

            // Prepočet cien
            shippingDisplay.innerText = shippingCost.toFixed(2) + " €";
            const total = parseFloat(totalGoods) + shippingCost;
            totalDisplay.innerText = total.toFixed(2) + " €";
        }

        // Event Listeners
        radios.forEach(r => r.addEventListener('change', updateUI));
        
        // Inicializácia
        if (!document.querySelector('input[name="delivery_method"]:checked')) {
            radios[0].checked = true;
        }
        updateUI();
    });
</script>

<style>
    input[type="radio"] {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
    }
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 4px; }
</style>
{% endblock %}