{% extends 'products/base.html' %}

{% block content %}
<div class="container mx-auto px-6 py-12">

    <div class="mb-8">
        <h1 class="text-3xl font-black text-gray-900">
            Výsledky pre: <span class="text-blue-600">"{{ search_query }}"</span>
        </h1>

        {% if error_message %}
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mt-4 mb-6 relative shadow-sm" role="alert">
            <strong class="font-bold"><i class="fa fa-exclamation-circle"></i> Pozor:</strong>
            <span class="block sm:inline ml-1">{{ error_message }}</span>
        </div>
        {% endif %}
    </div>

    {% if products %}
    
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6" id="product-list">
        {% include 'products/partials/product_grid.html' %}
    </div>
    
    {% if has_next %}
    <div class="text-center mt-12 mb-8" id="load-more-container">
        <button id="load-more-btn" 
                data-page="{{ next_page }}" 
                data-url="{% url 'search' %}?q={{ search_query }}"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full transition duration-300 shadow-md flex items-center justify-center mx-auto gap-2">
            <span>Zobraziť ďalšie výsledky</span>
            <svg id="load-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </button>
    </div>
    {% endif %}

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const loadMoreBtn = document.getElementById('load-more-btn');
        
        if (loadMoreBtn) {
            loadMoreBtn.addEventListener('click', function() {
                const btn = this;
                // V data-url už máme ?q=slovo, takže page musíme pridať cez &
                const url = btn.getAttribute('data-url');
                const page = btn.getAttribute('data-page');
                
                const urlParams = new URLSearchParams(window.location.search);
                const sort = urlParams.get('sort') || 'default';
                
                btn.querySelector('span').textContent = 'Načítavam...';
                btn.querySelector('#load-spinner').classList.remove('hidden');
                btn.disabled = true;
                btn.classList.add('opacity-75', 'cursor-not-allowed');

                // Keďže v url už JE otáznik (?q=niečo), ďalšie parametre lepíme cez ampersand "&"
                fetch(`${url}&page=${page}&sort=${sort}&ajax=1`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('product-list').insertAdjacentHTML('beforeend', data.html);
                    
                    if (data.has_next) {
                        btn.setAttribute('data-page', parseInt(page) + 1);
                        btn.querySelector('span').textContent = 'Zobraziť ďalšie výsledky';
                        btn.querySelector('#load-spinner').classList.add('hidden');
                        btn.disabled = false;
                        btn.classList.remove('opacity-75', 'cursor-not-allowed');
                    } else {
                        document.getElementById('load-more-container').remove();
                    }
                })
                .catch(error => {
                    console.error('Chyba:', error);
                    btn.querySelector('span').textContent = 'Chyba siete. Skúste znova.';
                    btn.querySelector('#load-spinner').classList.add('hidden');
                    btn.disabled = false;
                });
            });
        }
    });
    </script>
    
    {% else %}
    
    {% if not error_message %}
    <div class="bg-gray-50 rounded-2xl p-12 text-center">
        <div class="text-gray-300 text-6xl mb-4"><i class="fa fa-search"></i></div>
        <h2 class="text-xl font-bold text-gray-800 mb-2">Nenašli sme žiadne produkty</h2>
        <p class="text-gray-500 mb-6">Skúste iný názov, EAN kód alebo sa vráťte na hlavnú stránku.</p>
        <a href="{% url 'home' %}" class="bg-blue-600 text-white px-6 py-3 rounded-full font-bold hover:bg-blue-700 transition">
            Zobraziť všetky produkty
        </a>
    </div>
    {% endif %}

    {% endif %}

</div>
{% endblock %}